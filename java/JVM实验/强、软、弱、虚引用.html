<html lang="en"><head>
    <meta charset="UTF-8">
    <title></title>
<style>#BAIDU_DSPUI_FLOWBAR,.adsbygoogle,.ad,div[class^="ad-widsget"],div[id^="div-gpt-ad-"],a[href*="@"][href*=".exe"],a[href*="/?/"][href*=".exe"],.adpushwin{display:none !important;}</style><style id="system" type="text/css">h1,h2,h3,h4,h5,h6,p,blockquote {    margin: 0;    padding: 0;}body {    font-family: "Helvetica Neue", Helvetica, "Hiragino Sans GB", Arial, sans-serif;    font-size: 13px;    line-height: 18px;    color: #737373;    margin: 10px 13px 10px 13px;}a {    color: #0069d6;}a:hover {    color: #0050a3;    text-decoration: none;}a img {    border: none;}p {    margin-bottom: 9px;}h1,h2,h3,h4,h5,h6 {    color: #404040;    line-height: 36px;}h1 {    margin-bottom: 18px;    font-size: 30px;}h2 {    font-size: 24px;}h3 {    font-size: 18px;}h4 {    font-size: 16px;}h5 {    font-size: 14px;}h6 {    font-size: 13px;}hr {    margin: 0 0 19px;    border: 0;    border-bottom: 1px solid #ccc;}blockquote {    padding: 13px 13px 21px 15px;    margin-bottom: 18px;    font-family:georgia,serif;    font-style: italic;}blockquote:before {    content:"C";    font-size:40px;    margin-left:-10px;    font-family:georgia,serif;    color:#eee;}blockquote p {    font-size: 14px;    font-weight: 300;    line-height: 18px;    margin-bottom: 0;    font-style: italic;}code, pre {    font-family: Monaco, Andale Mono, Courier New, monospace;}code {    background-color: #fee9cc;    color: rgba(0, 0, 0, 0.75);    padding: 1px 3px;    font-size: 12px;    -webkit-border-radius: 3px;    -moz-border-radius: 3px;    border-radius: 3px;}pre {    display: block;    padding: 14px;    margin: 0 0 18px;    line-height: 16px;    font-size: 11px;    border: 1px solid #d9d9d9;    white-space: pre-wrap;    word-wrap: break-word;}pre code {    background-color: #fff;    color:#737373;    font-size: 11px;    padding: 0;}@media screen and (min-width: 768px) {    body {        width: 748px;        margin:10px auto;    }}</style><style id="custom" type="text/css"></style></head>
<body><h1>强、软、弱、虚引用</h1>
<h2>软引用</h2>
<p>软引用是一种比强引用更弱的引用，当内存快要耗尽时，GC才会回收软引用
</p>
<h2>源码</h2>
<pre><code class="lang-java">package test;

import java.lang.ref.SoftReference;

public class Test {

    public static void main(String[] args) throws InterruptedException {

        User u = new User();
        u.setName("Clive");
        u.setAge(19);
        SoftReference&lt;User&gt; userSR = new SoftReference&lt;&gt;(u);
        u = null;
        System.out.println(userSR.get());
        System.gc();
        System.out.println(userSR.get());
        byte[] room = new byte[1*1024*1055*6]; //耗尽堆空间，不同的环境，这个room的大小需要调整
        System.gc();
        Thread.sleep(1000); //努力确保GC
        System.out.println(userSR.get());
    }

    private static class User {

        private String name;
        private int age;

        public User() {

        }

        public String getName() {
            return name;
        }

        public void setName(String name) {
            this.name = name;
        }

        public int getAge() {
            return age;
        }

        public void setAge(int age) {
            this.age = age;
        }

        @Override
        public String toString() {
            return String.format("[User:name=%s;age=%d]",name,age);
        }

    }
}</code></pre>
<h2>VM arguments</h2>
<p>-XX:+PrintCommandLineFlags
-Xmx10m

</p>
<h2>console</h2>
<p>-XX:InitialHeapSize=10485760 -XX:MaxHeapSize=10485760 -XX:+PrintCommandLineFlags -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:-UseLargePagesIndividualAllocation -XX:+UseParallelGC 
[User:name=Clive;age=19]
[User:name=Clive;age=19]
null

</p>
<h2>引用队列</h2>
<p>当某个软、弱、虚引用被GC处理后，就会加入相应的引用队列中

</p>
<h2>源码</h2>
<pre><code class="lang-java">package test;

import java.lang.ref.ReferenceQueue;
import java.lang.ref.SoftReference;

public class Test {

    public static void main(String[] args) throws InterruptedException {

        ReferenceQueue&lt;User&gt; referenceQueue = new ReferenceQueue&lt;&gt;();
        Thread t = new Thread(new CleanReferenceQueue&lt;User&gt;(referenceQueue));
        t.setDaemon(true);
        t.start();
        User user = new User();
        user.setName("Clive");
        user.setAge(1);
        UserReference userR = new UserReference(user,referenceQueue);
        System.out.println(userR.get());
        user = null;
        System.out.println(userR.get());
        System.gc();
        Thread.sleep(1000);
        System.out.println(userR.get());
        byte[] room = new byte[1*1024*1055*6]; //耗尽堆空间，不同的环境，这个room的大小需要调整
        System.gc();
        Thread.sleep(1000); //努力确保GC
        System.out.println(userR.get()); //null
        System.out.println(userR); //not null
    }

    private static class User {

        private String name;
        private int age;

        public User() {

        }

        public String getName() {
            return name;
        }
        public void setName(String name) {
            this.name = name;
        }
        public int getAge() {
            return age;
        }
        public void setAge(int age) {
            this.age = age;
        }

        @Override
        public String toString() {
            return String.format("[User:name=%s;age=%d]",name,age);
        }
    }

    /**
     * @author 付大石
     * 清除引用队列中的无效引用
     */
    private static class CleanReferenceQueue&lt;T&gt; implements Runnable {

        private ReferenceQueue&lt;T&gt; referenceQueue;

        public CleanReferenceQueue(ReferenceQueue&lt;T&gt; referenceQueue) {
            this.referenceQueue = referenceQueue;
        }

        @Override
        public void run() {

            while(true) {
                try {
                    UserReference reference = (UserReference) referenceQueue.remove();
//                    System.out.println("清除："+reference.get().getName()); //NPE
                    System.out.println("清除："+reference);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }
        }
    }

    private static class UserReference extends SoftReference&lt;User&gt; {

        private String name;

        public UserReference(User reference, ReferenceQueue&lt;? super User&gt; q) {
            super(reference, q);
            this.name = reference.name;
        }

        public String getName() {
            return name;
        }

        @Override
        public String toString() {
            return String.format("[UserReference:name=%s]",name);
        }
    }
}</code></pre>
<h2>VM arguments</h2>
<p>-XX:+PrintCommandLineFlags
-Xmx10m

</p>
<h2>console</h2>
<p>-XX:InitialHeapSize=10485760 -XX:MaxHeapSize=10485760 -XX:+PrintCommandLineFlags -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:-UseLargePagesIndividualAllocation -XX:+UseParallelGC 
[User:name=Clive;age=1]
[User:name=Clive;age=1]
[User:name=Clive;age=1]
清除：[UserReference:name=Clive]
null
[UserReference:name=Clive]



</p>
<h2>弱引用</h2>
<p>弱引用是比软引用更弱的一种引用，当GC发生时，该引用指向的内存区域就会被清理

</p>
<h2>源码</h2>
<pre><code class="lang-java">package test;

import java.lang.ref.ReferenceQueue;
import java.lang.ref.SoftReference;
import java.lang.ref.WeakReference;

public class Test {

    public static void main(String[] args) throws InterruptedException {

        User user = new User();
        user.setAge(1);
        user.setName("Clive");
        WeakReference&lt;User&gt; userWR = new WeakReference&lt;&gt;(user);
        user = null;
        System.gc();
        Thread.sleep(1000);
        System.out.println(userWR.get());
    }

    private static class User {

        private String name;
        private int age;

        public User() {

        }

        public String getName() {
            return name;
        }
        public void setName(String name) {
            this.name = name;
        }
        public int getAge() {
            return age;
        }
        public void setAge(int age) {
            this.age = age;
        }

        @Override
        public String toString() {
            return String.format("[User:name=%s;age=%d]",name,age);
        }
    }
}</code></pre>
<h2>VM arguments</h2>
<p>-XX:+PrintCommandLineFlags
-Xmx10m

</p>
<h2>console</h2>
<p>-XX:InitialHeapSize=10485760 -XX:MaxHeapSize=10485760 -XX:+PrintCommandLineFlags -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:-UseLargePagesIndividualAllocation -XX:+UseParallelGC 
</p>
<hr>
<p>null

</p>
<h2>虚引用</h2>
<p>所以他妈虚引用存在的意义是什么？！！

</p>
<p>Edit By <a href="http://mahua.jser.me">MaHua</a></p>
</body></html>